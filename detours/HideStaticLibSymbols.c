#define ACCESSED_FLAGS __CRAP__COMPILER__ACCESSED_FLAGS
#define INSTR_ENCODINGS __CRAP__COMPILER__INSTR_ENCODINGS
#define REGISTER_MAP __CRAP__COMPILER__REGISTER_MAP
#define STR_INSTRUCTIONCATEGORY __CRAP__COMPILER__STR_INSTRUCTIONCATEGORY
#define STR_ISAEXT __CRAP__COMPILER__STR_ISAEXT
#define STR_ISASET __CRAP__COMPILER__STR_ISASET
#define STR_MNEMONIC __CRAP__COMPILER__STR_MNEMONIC
#define STR_REGISTER __CRAP__COMPILER__STR_REGISTER
#define FILTERS_XOP __CRAP__COMPILER__FILTERS_XOP
#define FILTERS_VEX __CRAP__COMPILER__FILTERS_VEX
#define FILTERS_EMVEX __CRAP__COMPILER__FILTERS_EMVEX
#define FILTERS_OPCODE __CRAP__COMPILER__FILTERS_OPCODE
#define FILTERS_MODE __CRAP__COMPILER__FILTERS_MODE
#define FILTERS_MODE_COMPACT __CRAP__COMPILER__FILTERS_MODE_COMPACT
#define FILTERS_MODRM_MOD __CRAP__COMPILER__FILTERS_MODRM_MOD
#define FILTERS_MODRM_MOD_COMPACT __CRAP__COMPILER__FILTERS_MODRM_MOD_COMPACT
#define FILTERS_MODRM_REG __CRAP__COMPILER__FILTERS_MODRM_REG
#define FILTERS_MODRM_RM __CRAP__COMPILER__FILTERS_MODRM_RM
#define FILTERS_MANDATORY_PREFIX __CRAP__COMPILER__FILTERS_MANDATORY_PREFIX
#define FILTERS_OPERAND_SIZE __CRAP__COMPILER__FILTERS_OPERAND_SIZE
#define FILTERS_ADDRESS_SIZE __CRAP__COMPILER__FILTERS_ADDRESS_SIZE
#define FILTERS_VECTOR_LENGTH __CRAP__COMPILER__FILTERS_VECTOR_LENGTH
#define FILTERS_REX_W __CRAP__COMPILER__FILTERS_REX_W
#define FILTERS_REX_B __CRAP__COMPILER__FILTERS_REX_B
#define FILTERS_EVEX_B __CRAP__COMPILER__FILTERS_EVEX_B
#define FILTERS_MVEX_E __CRAP__COMPILER__FILTERS_MVEX_E
#define FILTERS_MODE_AMD __CRAP__COMPILER__FILTERS_MODE_AMD
#define FILTERS_MODE_KNC __CRAP__COMPILER__FILTERS_MODE_KNC
#define FILTERS_MODE_MPX __CRAP__COMPILER__FILTERS_MODE_MPX
#define FILTERS_MODE_CET __CRAP__COMPILER__FILTERS_MODE_CET
#define FILTERS_MODE_LZCNT __CRAP__COMPILER__FILTERS_MODE_LZCNT
#define FILTERS_MODE_TZCNT __CRAP__COMPILER__FILTERS_MODE_TZCNT
#define FILTERS_MODE_WBNOINVD __CRAP__COMPILER__FILTERS_MODE_WBNOINVD
#define FILTERS_MODE_CLDEMOTE __CRAP__COMPILER__FILTERS_MODE_CLDEMOTE
#define FILTERS_MODE_CENTAUR __CRAP__COMPILER__FILTERS_MODE_CENTAUR
#define ISTR_DEFINITIONS_LEGACY __CRAP__COMPILER__ISTR_DEFINITIONS_LEGACY
#define ISTR_DEFINITIONS_3DNOW __CRAP__COMPILER__ISTR_DEFINITIONS_3DNOW
#define ISTR_DEFINITIONS_XOP __CRAP__COMPILER__ISTR_DEFINITIONS_XOP
#define ISTR_DEFINITIONS_VEX __CRAP__COMPILER__ISTR_DEFINITIONS_VEX
#define ISTR_DEFINITIONS_EVEX __CRAP__COMPILER__ISTR_DEFINITIONS_EVEX
#define ISTR_DEFINITIONS_MVEX __CRAP__COMPILER__ISTR_DEFINITIONS_MVEX
#define OPERAND_DEFINITIONS __CRAP__COMPILER__OPERAND_DEFINITIONS
#define ZydisCategoryGetString __CRAP__COMPILER__ZydisCategoryGetString
#define ZydisISASetGetString __CRAP__COMPILER__ZydisISASetGetString
#define ZydisISAExtGetString __CRAP__COMPILER__ZydisISAExtGetString
#define ZydisMnemonicGetString __CRAP__COMPILER__ZydisMnemonicGetString
#define ZydisMnemonicGetStringWrapped __CRAP__COMPILER__ZydisMnemonicGetStringWrapped
#define ZydisRegisterEncode __CRAP__COMPILER__ZydisRegisterEncode
#define ZydisRegisterGetId __CRAP__COMPILER__ZydisRegisterGetId
#define ZydisRegisterGetClass __CRAP__COMPILER__ZydisRegisterGetClass
#define ZydisRegisterGetWidth __CRAP__COMPILER__ZydisRegisterGetWidth
#define ZydisRegisterGetLargestEnclosing __CRAP__COMPILER__ZydisRegisterGetLargestEnclosing
#define ZydisRegisterGetString __CRAP__COMPILER__ZydisRegisterGetString
#define ZydisRegisterGetStringWrapped __CRAP__COMPILER__ZydisRegisterGetStringWrapped
#define ZydisRegisterClassGetWidth __CRAP__COMPILER__ZydisRegisterClassGetWidth
#define ZydisDecoderInit __CRAP__COMPILER__ZydisDecoderInit
#define ZydisDecoderEnableMode __CRAP__COMPILER__ZydisDecoderEnableMode
#define ZydisDecoderDecodeBuffer __CRAP__COMPILER__ZydisDecoderDecodeBuffer
#define ZydisCalcAbsoluteAddress __CRAP__COMPILER__ZydisCalcAbsoluteAddress
#define ZydisCalcAbsoluteAddressEx __CRAP__COMPILER__ZydisCalcAbsoluteAddressEx
#define ZydisGetAccessedFlagsByAction __CRAP__COMPILER__ZydisGetAccessedFlagsByAction
#define ZydisGetAccessedFlagsRead __CRAP__COMPILER__ZydisGetAccessedFlagsRead
#define ZydisGetAccessedFlagsWritten __CRAP__COMPILER__ZydisGetAccessedFlagsWritten
#define ZydisGetInstructionSegments __CRAP__COMPILER__ZydisGetInstructionSegments
#define ZydisGetVersion __CRAP__COMPILER__ZydisGetVersion
#define ZydisIsFeatureEnabled __CRAP__COMPILER__ZydisIsFeatureEnabled
#define ZydisDecoderTreeGetRootNode __CRAP__COMPILER__ZydisDecoderTreeGetRootNode
#define ZydisDecoderTreeGetChildNode __CRAP__COMPILER__ZydisDecoderTreeGetChildNode
#define ZydisGetInstructionEncodingInfo __CRAP__COMPILER__ZydisGetInstructionEncodingInfo
#define ZydisGetInstructionDefinition __CRAP__COMPILER__ZydisGetInstructionDefinition
#define ZydisGetOperandDefinitions __CRAP__COMPILER__ZydisGetOperandDefinitions
#define ZydisGetElementInfo __CRAP__COMPILER__ZydisGetElementInfo
#define ZydisGetAccessedFlags __CRAP__COMPILER__ZydisGetAccessedFlags
#define ZydisStringAppend __CRAP__COMPILER__ZydisStringAppend
#define ZydisStringAppendDecU __CRAP__COMPILER__ZydisStringAppendDecU
#define ZydisStringAppendHexU __CRAP__COMPILER__ZydisStringAppendHexU
#define ZydisStringAppendDecU64 __CRAP__COMPILER__ZydisStringAppendDecU64
#define ZydisStringAppendHexU64 __CRAP__COMPILER__ZydisStringAppendHexU64
#define ZydisCalcRegisterId __CRAP__COMPILER__ZydisCalcRegisterId
#define ZydisCheckErrorConditions __CRAP__COMPILER__ZydisCheckErrorConditions
#define ZydisCollectOptionalPrefixes __CRAP__COMPILER__ZydisCollectOptionalPrefixes
#define ZydisDecodeEVEX __CRAP__COMPILER__ZydisDecodeEVEX
#define ZydisDecodeInstruction __CRAP__COMPILER__ZydisDecodeInstruction
#define ZydisDecodeOperandImplicitMemory __CRAP__COMPILER__ZydisDecodeOperandImplicitMemory
#define ZydisDecodeOperandImplicitRegister __CRAP__COMPILER__ZydisDecodeOperandImplicitRegister
#define ZydisDecodeOperandMemory __CRAP__COMPILER__ZydisDecodeOperandMemory
#define ZydisDecodeOperandRegister __CRAP__COMPILER__ZydisDecodeOperandRegister
#define ZydisDecodeOperands __CRAP__COMPILER__ZydisDecodeOperands
#define ZydisDecodeOptionalInstructionParts __CRAP__COMPILER__ZydisDecodeOptionalInstructionParts
#define ZydisNodeHandlerOpcode __CRAP__COMPILER__ZydisNodeHandlerOpcode
#define ZydisReadDisplacement __CRAP__COMPILER__ZydisReadDisplacement
#define ZydisReadImmediate __CRAP__COMPILER__ZydisReadImmediate
#define ZydisSetAVXInformation __CRAP__COMPILER__ZydisSetAVXInformation
#define ZydisSetAttributes __CRAP__COMPILER__ZydisSetAttributes
#define ZydisSetOperandSizeAndElementInfo __CRAP__COMPILER__ZydisSetOperandSizeAndElementInfo

#include <Zydis/Zydis.h>
#include "zydis/src/Decoder.c"
#include "zydis/src/DecoderData.c"
#include "zydis/src/MetaInfo.c"
#include "zydis/src/Mnemonic.c"
#include "zydis/src/Register.c"
#include "zydis/src/SharedData.c"
#include "zydis/src/String.c"
#include "zydis/src/Utils.c"
#include "zydis/src/Zydis.c"

static ZydisDecoder g_DetoursZydisDecoder;

int DetoursInitZydis32()
{
	if (ZYAN_FAILED(ZydisDecoderInit(&g_DetoursZydisDecoder, ZYDIS_MACHINE_MODE_LEGACY_32, ZYDIS_ADDRESS_WIDTH_32)))
		return -1;

	return 1;
}

int DetoursInitZydis64()
{
	if (ZYAN_FAILED(ZydisDecoderInit(&g_DetoursZydisDecoder, ZYDIS_MACHINE_MODE_LONG_64, ZYDIS_ADDRESS_WIDTH_64)))
		return -1;

	return 1;
}

int DetoursGetNextInstructionLength(void *Instruction)
{
	ZydisDecodedInstruction instruction;

	if (ZYAN_SUCCESS(ZydisDecoderDecodeBuffer(&g_DetoursZydisDecoder, Instruction, ZYDIS_MAX_INSTRUCTION_LENGTH, &instruction)))
		return instruction.length;

	return -1;
}